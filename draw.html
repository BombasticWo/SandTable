<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Sand Table Drawer (Marble Safe)</title>

    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #f0f0f0;
            padding: 20px;
        }

        canvas {
            border: 2px solid #333;
            background: white;
            cursor: crosshair;
            margin-bottom: 15px;
        }

        .controls, .text-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        button {
            padding: 8px 14px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
        }

        #downloadBtn { background: #27ae60; }
        #clearBtn { background: #e74c3c; }
        #backBtn { background: #7f8c8d; }
        #addTextBtn { background: #9b59b6; }
        #deleteTextBtn { background: #c0392b; }

        textarea {
            width: 420px;
            height: 200px;
            font-family: monospace;
        }
    </style>
</head>

<body>

<h2>Sand Table Draw â†’ G-Code</h2>
<p>Marble Sand Table - 180mm x 180mm</p>

<div class="controls">
    <button id="downloadBtn">Download G-Code</button>
    <input id="filenameInput" value="drawing">
    <span>.gcode</span>
    <button id="clearBtn">Clear</button>
    <button id="backBtn">Back to Menu</button>
</div>

<div class="text-controls">
    <input id="textInput" placeholder="Text">
    <select id="fontSelect">
        <option>Arial</option>
        <option>Times New Roman</option>
        <option>Courier New</option>
        <option>Georgia</option>
        <option>Verdana</option>
    </select>
    <input id="fontSizeInput" type="number" value="16" min="8">
    <button id="addTextBtn">Add Text</button>
    <button id="deleteTextBtn">Delete Text</button>
</div>

<canvas id="drawingCanvas" width="500" height="500"></canvas>

<h3>G-Code Preview</h3>
<textarea id="gcodePreview" readonly></textarea>

<script>
const canvas = document.getElementById('drawingCanvas');
const ctx = canvas.getContext('2d');

const SMOOTHING_WINDOW = 5;
const MIN_DISTANCE = 2;

let strokes = [];
let currentStroke = [];
let textElements = [];
let isDrawing = false;
let isAddingText = false;

ctx.lineWidth = 2;
ctx.lineCap = 'round';

/* ---------- MOUSE ---------- */

canvas.addEventListener('mousedown', e => {
    if (isAddingText) return;
    isDrawing = true;
    currentStroke = [getMouse(e)];
    ctx.beginPath();
    ctx.moveTo(currentStroke[0].x, currentStroke[0].y);
});

canvas.addEventListener('mousemove', e => {
    if (!isDrawing) return;
    const p = getMouse(e);
    currentStroke.push(p);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
});

canvas.addEventListener('mouseup', finishStroke);
canvas.addEventListener('mouseleave', finishStroke);

canvas.addEventListener('click', e => {
    if (!isAddingText) return;
    const p = getMouse(e);
    textElements.push({
        text: textInput.value,
        x: p.x,
        y: p.y,
        font: fontSelect.value,
        fontSize: parseInt(fontSizeInput.value)
    });
    isAddingText = false;
    redraw();
    updatePreview();
});

/* ---------- HELPERS ---------- */

function getMouse(e) {
    const r = canvas.getBoundingClientRect();
    return { x: e.clientX - r.left, y: e.clientY - r.top };
}

function finishStroke() {
    if (isDrawing && currentStroke.length > 1) {
        strokes.push(smoothStroke(currentStroke));
    }
    isDrawing = false;
    updatePreview();
}

function smoothStroke(points) {
    const filtered = [points[0]];
    for (let i = 1; i < points.length; i++) {
        const dx = points[i].x - filtered.at(-1).x;
        const dy = points[i].y - filtered.at(-1).y;
        if (Math.hypot(dx, dy) >= MIN_DISTANCE) filtered.push(points[i]);
    }

    return filtered.map((_, i, arr) => {
        let sx = 0, sy = 0, c = 0;
        for (let j = -SMOOTHING_WINDOW; j <= SMOOTHING_WINDOW; j++) {
            const k = i + j;
            if (k >= 0 && k < arr.length) {
                sx += arr[k].x;
                sy += arr[k].y;
                c++;
            }
        }
        return { x: sx / c, y: sy / c };
    });
}

/* ---------- DRAW ---------- */

function redraw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    strokes.forEach(s => {
        ctx.beginPath();
        ctx.moveTo(s[0].x, s[0].y);
        s.forEach(p => ctx.lineTo(p.x, p.y));
        ctx.stroke();
    });

    textElements.forEach(t => {
        ctx.font = `bold ${t.fontSize}px ${t.font}`;
        ctx.fillText(t.text, t.x, t.y);
    });
}

/* ---------- G-CODE ---------- */

function convertToGCode() {
    const scale = 180 / 500;
    const g = [
        'G90', // absolute
        'G21'  // mm
    ];

    strokes.forEach(s => {
        let x = s[0].x * scale;
        let y = (500 - s[0].y) * scale;
        g.push(`G0 X${x.toFixed(2)} Y${y.toFixed(2)}`);
        for (let i = 1; i < s.length; i++) {
            x = s[i].x * scale;
            y = (500 - s[i].y) * scale;
            g.push(`G1 X${x.toFixed(2)} Y${y.toFixed(2)} F1000`);
        }
    });

    return g.join('\n');
}

function updatePreview() {
    gcodePreview.value = convertToGCode();
}

/* ---------- UI ---------- */

addTextBtn.onclick = () => isAddingText = true;

deleteTextBtn.onclick = () => {
    textElements = [];
    redraw();
    updatePreview();
};

clearBtn.onclick = () => {
    strokes = [];
    textElements = [];
    redraw();
    updatePreview();
};

downloadBtn.onclick = () => {
    if (!strokes.length) return alert('Nothing to export');
    const a = document.createElement('a');
    a.href = 'data:text/plain,' + encodeURIComponent(convertToGCode());
    a.download = (filenameInput.value || 'drawing') + '.gcode';
    a.click();
};

/* ---------- BACK BUTTON ---------- */
/* Change 'index.html' if your main menu file has a different name */
backBtn.onclick = () => {
    window.location.href = 'index.html';
};
</script>

</body>
</html>
